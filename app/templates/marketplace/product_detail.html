{% extends "base.html" %}
{% block title %}{{ product.title }}{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-lg-6">
    {% set imgs = product.media | selectattr("media_type", "equalto", "image") | list %}
    {% set vids = product.media | selectattr("media_type", "equalto", "video") | list %}

    {% set main_img = imgs[0].url if imgs else "https://picsum.photos/seed/item/900/700" %}

    <img id="mainProductImage" src="{{ main_img }}" class="img-fluid rounded-4 border" alt="product">

    {% if imgs|length > 1 %}
      <div class="d-flex gap-2 mt-3 flex-wrap">
        {% for m in imgs %}
          <img
            src="{{ m.url }}"
            data-full="{{ m.url }}"
            class="rounded border thumb-img"
            style="width:72px;height:72px;object-fit:cover;cursor:pointer;"
            alt="thumb"
          >
        {% endfor %}

      </div>
    {% endif %}

    {% if vids %}
      <div class="mt-3">
        <div class="fw-semibold mb-1">Video</div>
        <video class="w-100 rounded border" controls>
          <source src="{{ vids[0].url }}">
          Your browser does not support the video tag.
        </video>
      </div>
    {% endif %}

  </div>
  <div class="col-lg-6">
    <div class="d-flex gap-2 align-items-center">
      <span class="badge text-bg-secondary">{{ product.category.name }}</span>
      <span class="badge text-bg-light border">{{ product.condition }}</span>
      <span class="small text-muted">{{ product.city }}</span>
    </div>
    <h1 class="h3 mt-2">{{ product.title }}</h1>
    <div class="h4">${{ "%.2f"|format(product.price) }}</div>
    <p class="text-muted">{{ product.description }}</p>

    {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('market.cart_add', product_id=product.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-dark">Add to cart</button>
          <a class="btn btn-outline-dark" href="{{ url_for('market.contact_seller', product_id=product.id) }}">Contact seller</a>
      </form>

    {% else %}
      <div class="alert alert-warning mt-3">Login to add to cart or message the seller.</div>
    {% endif %}
  </div>
</div>

</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const main = document.getElementById("mainProductImage");
    const thumbs = document.querySelectorAll(".thumb-img");

    thumbs.forEach(t => {
      t.addEventListener("click", () => {
        const nextSrc = t.getAttribute("data-full") || t.getAttribute("src");
        if (nextSrc && main) main.src = nextSrc;

        thumbs.forEach(x => x.classList.remove("border-primary"));
        t.classList.add("border-primary");
      });
    });
  });
</script>

{% endblock %}
