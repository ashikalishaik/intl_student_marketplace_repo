{% extends "base.html" %}
{% block title %}{{ product.title }}{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-lg-6">
    {% set imgs = product.media | selectattr("media_type", "equalto", "image") | list %}
    {% set vids = product.media | selectattr("media_type", "equalto", "video") | list %}

    {% set main_img = imgs[0].url if imgs else "https://picsum.photos/seed/item/900/700" %}

    <img id="mainImage" src="{{ main_img }}" class="img-fluid rounded-4 border" alt="product">

    {% if imgs|length > 1 %}
      <div class="d-flex gap-2 mt-3 flex-wrap">
        {% for m in imgs %}
          <button type="button" class="p-0 border-0 bg-transparent" onclick="swapMainImage('{{ m.url }}')">
            <img src="{{ m.url }}" style="width:72px;height:72px;object-fit:cover;" class="rounded border" alt="thumb">
          </button>
        {% endfor %}
      </div>
    {% endif %}

    {% if vids %}
      <div class="mt-3">
        <div class="fw-semibold mb-1">Video</div>
        <video class="w-100 rounded border" controls>
          <source src="{{ vids[0].url }}">
          Your browser does not support the video tag.
        </video>
      </div>
    {% endif %}
  </div>

  <div class="col-lg-6">
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <span class="badge text-bg-secondary">{{ product.category.name }}</span>
      <span class="badge text-bg-light border">{{ product.condition }}</span>
      <span class="small text-muted">{{ product.city }}</span>

      {% if current_user.is_authenticated and (current_user.id == product.seller_id or current_user.is_admin()) %}
        <a class="btn btn-outline-dark btn-sm ms-auto" href="{{ url_for('market.edit_product', product_id=product.id) }}">Edit</a>
      {% endif %}
    </div>

    <h1 class="h3 mt-2">{{ product.title }}</h1>
    <div class="h4">${{ "%.2f"|format(product.price) }}</div>

    {% if product.quantity is not none %}
      <div class="small text-muted">In stock: {{ product.quantity }}</div>
    {% endif %}

    <p class="text-muted mt-2">{{ product.description }}</p>

    {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('market.cart_add', product_id=product.id) }}" class="d-flex gap-2 align-items-end flex-wrap">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div>
            <label class="form-label small mb-1">Qty</label>
            <input
              type="number"
              name="qty"
              class="form-control"
              value="1"
              min="1"
              {% if product.quantity is not none %}max="{{ product.quantity }}"{% endif %}
              style="max-width: 120px;"
            >
          </div>

          <button class="btn btn-dark" {% if product.quantity is not none and product.quantity <= 0 %}disabled{% endif %}>Add to cart</button>
          <a class="btn btn-outline-dark" href="{{ url_for('market.contact_seller', product_id=product.id) }}">Contact seller</a>
      </form>

    {% else %}
      <div class="alert alert-warning mt-3">Login to add to cart or message the seller.</div>
    {% endif %}
  </div>
</div>

<script>
  function swapMainImage(url) {
    const img = document.getElementById('mainImage');
    if (img) img.src = url;
  }
</script>
{% endblock %}
