{% extends "base.html" %}
{% block title %}Marketplace{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h1 class="h4 mb-0">Marketplace</h1>
  {% if current_user.is_authenticated %}
    <a class="btn btn-sm btn-dark" href="{{ url_for('market.sell') }}">Create listing</a>
  {% endif %}
</div>

<form class="row g-2 mt-3" method="get">
  <div class="col-md-5"><input class="form-control" name="q" value="{{ request.args.get('q','') }}" placeholder="Search products"></div>
  <div class="col-md-3"><input class="form-control" name="city" value="{{ request.args.get('city','') }}" placeholder="City"></div>
  <div class="col-md-4">
    <select class="form-select" name="cat">
      <option value="">All categories</option>
      {% for c in categories %}
        <option value="{{ c.id }}" {% if (request.args.get('cat')|int) == c.id %}selected{% endif %}>{{ c.name }}</option>

      {% endfor %}
    </select>
  </div>
  <div class="col-12"><button class="btn btn-outline-dark">Filter</button></div>
</form>

<div class="row row-cols-1 row-cols-md-4 g-3 mt-2">
  {% for p in products %}
  <div class="col">
    <div class="card h-100 shadow-sm">
      {% set imgs = p.media | selectattr("media_type", "equalto", "image") | list %}
      {% set img = imgs[0].url if imgs else "https://picsum.photos/seed/item/800/600" %}

      <img src="{{ img }}" class="card-img-top" alt="product">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <span class="badge text-bg-secondary">{{ p.category.name }}</span>
          <span class="fw-semibold">${{ "%.2f"|format(p.price) }}</span>
        </div>
        <div class="mt-2 fw-semibold">{{ p.title }}</div>
        <div class="small text-muted">{{ p.city }} â€¢ {{ p.condition }}</div>
      </div>
      <div class="card-footer bg-white border-0">
        <a class="btn btn-sm btn-outline-dark w-100" href="{{ url_for('market.product_detail', product_id=p.id) }}">View</a>
      </div>
    </div>
  </div>
  {% else %}
    <p class="text-muted mt-3">No products found.</p>
  {% endfor %}
</div>
{% endblock %}
